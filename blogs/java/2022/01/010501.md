---
title: Canal+RabbitMQå®ç°æ•°æ®å¢é‡åŒæ­¥
date: 2022-01-05
sidebar: auto
sticky: 2
categories:
 - java
tags:
 - Canal
 - RabbitMQ
---

## Canal+RabbitMQå®ç°æ•°æ®å¢é‡åŒæ­¥ğŸ§¨

### Canalæ˜¯ä»€ä¹ˆï¼ŸğŸ§

**canal [kÉ™'nÃ¦l]**ï¼Œè¯‘æ„ä¸ºæ°´é“/ç®¡é“/æ²Ÿæ¸ ï¼Œä¸»è¦ç”¨é€”æ˜¯åŸºäº MySQL æ•°æ®åº“å¢é‡æ—¥å¿—è§£æï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…å’Œæ¶ˆè´¹ï¼›

[å®˜æ–¹åœ°å€]: https://github.com/alibaba/canal

åŸºäºæ—¥å¿—å¢é‡è®¢é˜…å’Œæ¶ˆè´¹çš„ä¸šåŠ¡åŒ…æ‹¬

- æ•°æ®åº“é•œåƒ
- æ•°æ®åº“å®æ—¶å¤‡ä»½
- ç´¢å¼•æ„å»ºå’Œå®æ—¶ç»´æŠ¤(æ‹†åˆ†å¼‚æ„ç´¢å¼•ã€å€’æ’ç´¢å¼•ç­‰)
- ä¸šåŠ¡ cache åˆ·æ–°
- å¸¦ä¸šåŠ¡é€»è¾‘çš„å¢é‡æ•°æ®å¤„ç†

å½“å‰çš„ canal æ”¯æŒæºç«¯ MySQL ç‰ˆæœ¬åŒ…æ‹¬ 5.1.x , 5.5.x , 5.6.x , 5.7.x , 8.0.x

### å·¥ä½œåŸç†ğŸ¤”
**canal å·¥ä½œåŸç†**

- canal æ¨¡æ‹Ÿ MySQL slave çš„äº¤äº’åè®®ï¼Œä¼ªè£…è‡ªå·±ä¸º MySQL slave ï¼Œå‘ MySQL master å‘é€dump åè®®
- MySQL master æ”¶åˆ° dump è¯·æ±‚ï¼Œå¼€å§‹æ¨é€ binary log ç»™ slave (å³ canal )
- canal è§£æ binary log å¯¹è±¡(åŸå§‹ä¸º byte æµ)
<p>
<img :src="$withBase('/canal/1.png')" alt="canal1" class="medium-zoom-image">
</p>

**Canalåˆ†ä¸ºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼š**

- **æœåŠ¡ç«¯**ï¼šè´Ÿè´£è§£æMySQLçš„binlogæ—¥å¿—ï¼Œä¼ é€’å¢é‡æ•°æ®ç»™å®¢æˆ·ç«¯æˆ–è€…æ¶ˆæ¯ä¸­é—´ä»¶
- **å®¢æˆ·ç«¯**ï¼šè´Ÿè´£è§£ææœåŠ¡ç«¯ä¼ è¿‡æ¥çš„æ•°æ®ï¼Œç„¶åå®šåˆ¶è‡ªå·±çš„ä¸šåŠ¡å¤„ç†ã€‚

ç›®å‰ä¸ºæ­¢æ”¯æŒçš„æ¶ˆæ¯ä¸­é—´ä»¶å¾ˆå…¨é¢äº†ï¼Œæ¯”å¦‚**Kafka**ã€**RocketMQ**ï¼Œ**RabbitMQ**ã€‚

### æ•°æ®åŒæ­¥è¿˜æœ‰å…¶ä»–ä¸­é—´ä»¶å—ï¼ŸğŸ¤”

<p>
<img :src="$withBase('/canal/2.png')" alt="canal2" class="medium-zoom-image">
</p>

## CanalæœåŠ¡ç«¯å®‰è£…ğŸ›»

æœåŠ¡ç«¯ä¸‹è½½ï¼š[é“¾æ¥](https://github.com/alibaba/canal/releases) 

ä¸‹è½½åè§£å‹å¯å¾—(canal.deployer-1.1.5)

<p>
<img :src="$withBase('/canal/3.png')" alt="canal3" class="medium-zoom-image">
</p>

### 1ã€æ‰“å¼€MySQLçš„binlogæ—¥å¿—

ä¿®æ”¹MySQLçš„æ—¥å¿—æ–‡ä»¶ï¼Œmy.cnf é…ç½®å¦‚ä¸‹ï¼š

```
[mysqld]
log-bin=mysql-bin # å¼€å¯ binlog
binlog-format=ROW # é€‰æ‹© ROW æ¨¡å¼
server_id=1 # é…ç½® MySQL replaction éœ€è¦å®šä¹‰ï¼Œä¸è¦å’Œ canal çš„ slaveId é‡å¤
```

### 2ã€è®¾ç½®MySQLçš„é…ç½®

éœ€è¦è®¾ç½®æœåŠ¡ç«¯é…ç½®æ–‡ä»¶ä¸­çš„MySQLé…ç½®ï¼Œè¿™æ ·Canalæ‰èƒ½çŸ¥é“éœ€è¦ç›‘å¬å“ªä¸ªåº“ã€å“ªä¸ªè¡¨çš„æ—¥å¿—æ–‡ä»¶ã€‚

ä¸€ä¸ª Server å¯ä»¥é…ç½®å¤šä¸ªå®ä¾‹ç›‘å¬ ï¼ŒCanal åŠŸèƒ½é»˜è®¤è‡ªå¸¦çš„æœ‰ä¸ª example å®ä¾‹ï¼Œè¿™é‡Œæˆ‘å°±ç”¨ example å®ä¾‹ ã€‚å¦‚æœå¢åŠ å®ä¾‹ï¼Œå¤åˆ¶ example æ–‡ä»¶å¤¹å†…å®¹åˆ°åŒçº§ç›®å½•ä¸‹ï¼Œç„¶ååœ¨ canal.properties æŒ‡å®šæ·»åŠ å®ä¾‹çš„åç§°ã€‚

**ä¿®æ”¹canal.deployer-1.1.5\conf\example\instance.propertiesé…ç½®æ–‡ä»¶**

```
# url
canal.instance.master.address=127.0.0.1:3306
# username/password
canal.instance.dbUsername=root
canal.instance.dbPassword=root
# ç›‘å¬çš„æ•°æ®åº“
canal.instance.defaultDatabaseName=mydb

# ç›‘å¬çš„è¡¨ï¼Œå¯ä»¥æŒ‡å®šï¼Œå¤šä¸ªç”¨é€—å·åˆ†å‰²ï¼Œè¿™é‡Œæ­£åˆ™æ˜¯ç›‘å¬æ‰€æœ‰
canal.instance.filter.regex=.*\\..*

```

### 3ã€è®¾ç½®RabbitMQçš„é…ç½®

æœåŠ¡ç«¯é»˜è®¤çš„ä¼ è¾“æ–¹å¼æ˜¯**tcp**ï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®**MQ**çš„ç›¸å…³ä¿¡æ¯ã€‚

è¿™é‡Œéœ€è¦ä¿®æ”¹ä¸¤å¤„é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹

**1ã€canal.deployer-1.1.5\conf\canal.properties**

è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸»è¦æ˜¯è®¾ç½®MQç›¸å…³çš„é…ç½®ï¼Œæ¯”å¦‚URLï¼Œç”¨æˆ·åã€å¯†ç ...

```
# ä¼ è¾“æ–¹å¼ï¼štcp, kafka, rocketMQ, rabbitMQ
canal.serverMode = rabbitMQ
##################################################
######### 		    RabbitMQ	     #############
##################################################
rabbitmq.host = 127.0.0.1
rabbitmq.virtual.host =/
# exchange
rabbitmq.exchange =canal.exchange
# ç”¨æˆ·åã€å¯†ç 
rabbitmq.username =guest
rabbitmq.password =guest
## æ˜¯å¦æŒä¹…åŒ–
rabbitmq.deliveryMode = 2

```

2ã€**canal.deployer-1.1.5\conf\example\instance.properties**

è¿™ä¸ªæ–‡ä»¶è®¾ç½®MQçš„è·¯ç”±KEYï¼Œè¿™æ ·æ‰èƒ½è·¯ç”±åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ä¸­ï¼Œå¦‚ä¸‹ï¼š

```
canal.mq.topic=canal.routing.key

```

### 4ã€RabbitMQæ–°å»ºexchangeå’ŒQueue

åœ¨RabbitMQç®¡ç†æ§åˆ¶å°ä¸­éœ€è¦æ–°å»ºä¸€ä¸ªåç§°ä¸º:**canal.exchange**ï¼ˆå¿…é¡»å’Œé…ç½®ä¸­çš„ç›¸åŒä¸”äº¤æ¢æœºç±»å‹ä¸º**topic**ï¼‰çš„exchangeå’Œä¸€ä¸ªåç§°ä¸º **canal.queue**ï¼ˆåç§°éšæ„ï¼‰çš„é˜Ÿåˆ—ã€‚

å…¶ä¸­ç»‘å®šçš„è·¯ç”±KEYä¸ºï¼š**canal.routing.key**ï¼ˆå¿…é¡»å’Œé…ç½®ä¸­çš„ç›¸åŒï¼‰ï¼Œå¦‚ä¸‹å›¾ï¼š

<p>
<img :src="$withBase('/canal/4.png')" alt="canal4" class="medium-zoom-image">
</p>


### 5ã€å¯åŠ¨æœåŠ¡ç«¯

ç‚¹å‡»binç›®å½•ä¸‹çš„è„šæœ¬ï¼Œwindowsç›´æ¥åŒå‡»**startup.bat**ï¼š

**å¯åŠ¨å¯èƒ½æŠ¥é”™ï¼š**
<p>
<img :src="$withBase('/canal/5.png')" alt="canal5" class="medium-zoom-image">
</p>

**ä¿®æ”¹æ–¹æ¡ˆï¼šå»é™¤å›¾ä¸­æ ‡è®°çš„JVMé…ç½®**
<p>
<img :src="$withBase('/canal/6.png')" alt="canal6" class="medium-zoom-image">
</p>

**å¯åŠ¨æˆåŠŸå¦‚ä¸‹ï¼š**

<p>
<img :src="$withBase('/canal/7.png')" alt="canal7" class="medium-zoom-image">
</p>


### 6ã€æµ‹è¯•

åœ¨æœ¬åœ°æ•°æ®åº“ä¸­æ’å…¥ä¸€æ¡æ•°æ®ï¼Œå¦‚ä¸‹ï¼š

```sql
INSERT INTO T_ZB_BX VALUES (1,1,1);
```

æ­¤æ—¶æŸ¥çœ‹MQä¸­çš„**canal.queue**å·²ç»æœ‰äº†æ•°æ®ï¼Œå¦‚ä¸‹ï¼š

<p>
<img :src="$withBase('/canal/8.png')" alt="canal8" class="medium-zoom-image">
</p>

```json
{
	"data": [{
		"ID": "1",
		"ZB_ID": "1",
		"BX_ID": "1"
	}],
	"database": "w2db",
	"es": 1641285182000,
	"id": 2,
	"isDdl": false,
	"mysqlType": {
		"ID": "int(11)",
		"ZB_ID": "int(11)",
		"BX_ID": "int(11)"
	},
	"old": null,
	"pkNames": ["ID"],
	"sql": "",
	"sqlType": {
		"ID": 4,
		"ZB_ID": 4,
		"BX_ID": 4
	},
	"table": "T_ZB_BX",
	"ts": 1641285179543,
	"type": "INSERT"
}
```

è¯¥JSONæ•°æ®è¡¨è¿°å¾ˆæ˜ç¡®ï¼ŒåŒ…å«è¡¨åç§°ã€æ–¹æ³•ã€å‚æ•°ã€å‚æ•°ç±»å‹ã€å‚æ•°å€¼ç­‰ç­‰

**å®¢æˆ·ç«¯è¦åšçš„å°±æ˜¯ç›‘å¬MQè·å–JSONæ•°æ®ï¼Œç„¶åå°†å…¶è§£æå‡ºæ¥ï¼Œå¤„ç†è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ã€‚**

## Canalå®¢æˆ·ç«¯æ­å»ºğŸŒ‹

å®¢æˆ·ç«¯å¾ˆç®€å•å®ç°ï¼Œè¦åšçš„å°±æ˜¯æ¶ˆè´¹CanalæœåŠ¡ç«¯ä¼ é€’è¿‡æ¥çš„æ¶ˆæ¯ï¼Œç›‘å¬**canal.queue**è¿™ä¸ªé˜Ÿåˆ—ã€‚

### 1ã€åˆ›å»ºæ¶ˆæ¯å®ä½“ç±»

åˆ›å»ºä¸ªå®ä½“ç±»æ¥æ”¶MQä¼ é€’è¿‡æ¥çš„æ•°æ®

```java
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;
import lombok.NoArgsConstructor;
import java.util.List;

/**
 * @version 1.0.0
 * @className: CanalMessage
 * @description: é˜¿é‡ŒCanalä¸­é—´ä»¶æ¶ˆæ¯æ¥æ”¶å®ä½“ç±»
 * @author: LiJunYi
 * @create: 2022/1/4 16:44
 */
@NoArgsConstructor // æ— å‚æ„é€ å™¨  å¿…é¡»!!!
@Data
public class CanalMessage<T>
{
    @JsonProperty("data")
    private List<T> data;

    @JsonProperty("database")
    private String database;

    @JsonProperty("es")
    private Long es;

    @JsonProperty("id")
    private Integer id;

    @JsonProperty("isDdl")
    private Boolean isDdl;

    @JsonProperty("mysqlType")
    private Object mysqlType;

    @JsonProperty("old")
    private List<T> old;

    @JsonProperty("pkNames")
    private List<String> pkNames;

    @JsonProperty("sql")
    private String sql;

    @JsonProperty("sqlType")
    private Object sqlType;

    @JsonProperty("table")
    private String table;

    @JsonProperty("ts")
    private Long ts;

    @JsonProperty("type")
    private String type;
}


```

### **2ã€MQæ¶ˆæ¯ç›‘å¬ä¸šåŠ¡**

æ¥ä¸‹æ¥å°±æ˜¯ç›‘å¬é˜Ÿåˆ—ï¼Œä¸€æ—¦æœ‰CanalæœåŠ¡ç«¯æœ‰æ•°æ®æ¨é€èƒ½å¤ŸåŠæ—¶çš„æ¶ˆè´¹ã€‚

```java
import cn.hutool.json.JSONUtil;
import com.seecen.springbootrabbitmq.model.CanalMessage;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.Exchange;
import org.springframework.amqp.rabbit.annotation.Queue;
import org.springframework.amqp.rabbit.annotation.QueueBinding;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;
import java.nio.charset.StandardCharsets;

/**
 * @version 1.0.0
 * @className: CanalRabbitMQListener
 * @description: ç›‘å¬MQè·å–Canalå¢é‡çš„æ•°æ®æ¶ˆæ¯
 * @author: LiJunYi
 * @create: 2022/1/4 16:49
 */
@Component
@Slf4j
@RequiredArgsConstructor
public class CanalRabbitMQListener
{
   @RabbitListener(bindings = {
            @QueueBinding(
                    value = @Queue(value = "canal.queue", durable = "true"),
                    exchange = @Exchange(value = "canal.exchange", type = "topic"),
                    key = "canal.routing.key"
            )
    })
    public void handleDataChange(Message message)
   {
       // æ³¨æ„æ­¤å¤„MQä¼ æ¥çš„æ˜¯Byte[]
       byte[] ba = message.getBody();
       String s = new String(ba, StandardCharsets.UTF_8);
       String jsonStr = JSONUtil.toJsonStr(s);
       //ä½¿ç”¨Hutoolå·¥å…·å°†messageè½¬æ¢ä¸ºCanalMessage
       CanalMessage canalMessage = JSONUtil.toBean(jsonStr,CanalMessage.class);
       String tableName = canalMessage.getTable();
       //TODO åç»­é€»è¾‘å®Œå–„...............
    }
}


```

### 3ã€MQçš„æ•°æ®è§£æé…ç½®

```java
@Configuration
public class MyAMQPConfig {

    @Bean
    public MessageConverter messageConverter(){
        return new Jackson2JsonMessageConverter();
    }
}
```

### 4ã€æµ‹è¯•

å‘è¡¨ä¸­æ’å…¥æ•°æ®ï¼Œçœ‹ä¸‹æ¥æ”¶çš„æ¶ˆæ¯æ˜¯ä»€ä¹ˆæ ·çš„ï¼ŒSQLå¦‚ä¸‹ï¼š

```sql
INSERT INTO T_ZB_BX VALUES (1,1,1);
```

å®¢æˆ·ç«¯è½¬æ¢åçš„æ¶ˆæ¯å¦‚ä¸‹å›¾ï¼š

<p>
<img :src="$withBase('/canal/9.png')" alt="canal9" class="medium-zoom-image">
</p>

å›¾ä¸Šæ˜¾ç¤ºï¼ŒMQå‘é€è¿‡æ¥çš„æ‰€æœ‰çš„æ•°æ®éƒ½å·²ç»æˆåŠŸæ¥æ”¶åˆ°ï¼Œåç»­å¯æ ¹æ®å®é™…éœ€æ±‚å®Œå–„ä¸šåŠ¡é€»è¾‘ä»£ç å³å¯ã€‚









