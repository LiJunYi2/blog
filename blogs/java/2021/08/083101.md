---
title: ReentrantLockå¯é‡å…¥é”
date: 2021-08-31
sidebar: auto
categories:
 - java
tags:
 - é”
 - å¤šçº¿ç¨‹
---

## ReentrantLockå¯é‡å…¥é”ç®€å•ä»‹ç»âœ¨

**ä»JDK5å¼€å§‹ï¼Œå¼•å…¥äº†ä¸€ä¸ªé«˜çº§çš„å¤„ç†å¹¶å‘çš„java.util.concurrentåŒ…(å°±æ˜¯å¸¸è¯´çš„ï¼šJUCğŸ‹)ï¼Œå®ƒæä¾›äº†å¤§é‡æ›´é«˜çº§çš„å¹¶å‘åŠŸèƒ½ï¼Œèƒ½å¤§å¤§ç®€åŒ–å¤šçº¿ç¨‹ç¨‹åºçš„ç¼–å†™ã€‚è¿™é‡Œå°†ä»‹ç»JUCæä¾›çš„ï¼Œæ›¿ä»£synchronizedé”çš„ReentrantLock(å¯é‡å…¥é”)**

::: tip

**synchronizedå…³é”®å­—ç”¨äºåŠ é”ï¼Œä½†è¿™ç§é”ä¸€æ˜¯å¾ˆé‡ï¼ŒäºŒæ˜¯è·å–æ—¶å¿…é¡»ä¸€ç›´ç­‰å¾…ï¼Œæ²¡æœ‰é¢å¤–çš„å°è¯•æœºåˆ¶ã€‚**

:::

## ä¼ ç»Ÿçš„synchronizedé”ğŸ

```java
public class Counter {
    private int count;

    public void add(int n) {
        synchronized(this) {
            count += n;
        }
    }
}
```

## ReentrantLockæ›¿ä»£ğŸ‹

```java
public class Counter {
    private final Lock lock = new ReentrantLock();
    private int count;

    public void add(int n) {
        // è·å–é”
        lock.lock();
        try {
            count += n;
        } finally {
            // æœ€åå¿…é¡»é‡Šæ”¾é”
            lock.unlock();
        }
    }
}
```

## åŒºåˆ«â—

**ReentrantLockæ˜¯å¯é‡å…¥é”ï¼Œå®ƒå’Œsynchronizedä¸€æ ·ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€ä¸ªé”ã€‚**

**å’Œsynchronizedä¸åŒçš„æ˜¯ï¼ŒReentrantLockå¯ä»¥å°è¯•è·å–é”**

```java
if (lock.tryLock(1, TimeUnit.SECONDS)) {
    try {
        ...
    } finally {
        lock.unlock();
    }
}
```

ä¸Šè¿°ä»£ç åœ¨å°è¯•è·å–é”çš„æ—¶å€™ï¼Œæœ€å¤šç­‰å¾…1ç§’ã€‚å¦‚æœ1ç§’åä»æœªè·å–åˆ°é”ï¼ŒtryLock()è¿”å›falseï¼Œç¨‹åºå°±å¯ä»¥åšä¸€äº›é¢å¤–å¤„ç†ï¼Œè€Œä¸æ˜¯æ— é™ç­‰å¾…ä¸‹å»ã€‚

æ‰€ä»¥ï¼Œä½¿ç”¨ReentrantLockæ¯”ç›´æ¥ä½¿ç”¨synchronizedæ›´å®‰å…¨ï¼Œçº¿ç¨‹åœ¨tryLock()å¤±è´¥çš„æ—¶å€™ä¸ä¼šå¯¼è‡´æ­»é”ã€‚

## å°ç»“â­•

ReentrantLockå¯ä»¥æ›¿ä»£synchronizedè¿›è¡ŒåŒæ­¥ï¼›

ReentrantLockè·å–é”æ›´å®‰å…¨ï¼›

å¿…é¡»å…ˆè·å–åˆ°é”ï¼Œå†è¿›å…¥try {...}ä»£ç å—ï¼Œæœ€åä½¿ç”¨finallyä¿è¯é‡Šæ”¾é”ï¼›

å¯ä»¥ä½¿ç”¨tryLock()å°è¯•è·å–é”ã€‚

## ä½¿ç”¨Conditionå¯¹è±¡æ¥å®ç°waitå’Œnotifyçš„åŠŸèƒ½ã€‚ğŸ’¥

```java
class TaskQueue {
    private final Lock lock = new ReentrantLock();
    private final Condition condition = lock.newCondition();
    private Queue<String> queue = new LinkedList<>();

    public void addTask(String s) {
        lock.lock();
        try {
            queue.add(s);
            condition.signalAll();
        } finally {
            lock.unlock();
        }
    }

    public String getTask() {
        lock.lock();
        try {
            while (queue.isEmpty()) {
                condition.await();
            }
            return queue.remove();
        } finally {
            lock.unlock();
        }
    }
}
```

ä½¿ç”¨Conditionæ—¶ï¼Œå¼•ç”¨çš„Conditionå¯¹è±¡å¿…é¡»ä»Lockå®ä¾‹çš„newCondition()è¿”å›ï¼Œè¿™æ ·æ‰èƒ½è·å¾—ä¸€ä¸ªç»‘å®šäº†Lockå®ä¾‹çš„Conditionå®ä¾‹ã€‚

**Conditionæä¾›çš„await()ã€signal()ã€signalAll()åŸç†å’Œsynchronizedé”å¯¹è±¡çš„wait()ã€notify()ã€notifyAll()æ˜¯ä¸€è‡´çš„ï¼Œå¹¶ä¸”å…¶è¡Œä¸ºä¹Ÿæ˜¯ä¸€æ ·çš„ï¼š**

- **await()ä¼šé‡Šæ”¾å½“å‰é”ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼›**
- **signal()ä¼šå”¤é†’æŸä¸ªç­‰å¾…çº¿ç¨‹ï¼›**

- **signalAll()ä¼šå”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼›**
- **å”¤é†’çº¿ç¨‹ä»await()è¿”å›åéœ€è¦é‡æ–°è·å¾—é”ã€‚**

æ­¤å¤–ï¼Œå’ŒtryLock()ç±»ä¼¼ï¼Œawait()å¯ä»¥åœ¨ç­‰å¾…æŒ‡å®šæ—¶é—´åï¼Œå¦‚æœè¿˜æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹é€šè¿‡signal()æˆ–signalAll()å”¤é†’ï¼Œå¯ä»¥è‡ªå·±é†’æ¥

```java
if (condition.await(1, TimeUnit.SECOND)) {
    // è¢«å…¶ä»–çº¿ç¨‹å”¤é†’
} else {
    // æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹å”¤é†’
}
```

å¯è§ï¼Œä½¿ç”¨Conditioné…åˆLockï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æ›´çµæ´»çš„çº¿ç¨‹åŒæ­¥ã€‚

## å°ç»“ğŸ’«

Conditionå¯ä»¥æ›¿ä»£waitå’Œnotifyï¼›

Conditionå¯¹è±¡å¿…é¡»ä»Lockå¯¹è±¡è·å–ã€‚
