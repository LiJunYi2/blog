---
title: ConcurrentModificationException
date: 2021-08-22
sidebar: auto
categories:
 - java
tags:
 - Exception
---

## åœºæ™¯âœ¨

<p>
<img :src="$withBase('/collection/collection082202_1.png')" alt="collection082202_1" class="medium-zoom-image">
</p>

## è§£å†³æ–¹æ¡ˆâœŒ

<p>
<img :src="$withBase('/collection/collection082202_2.png')" alt="collection082202_2" class="medium-zoom-image">
</p>


## åŸå› åˆ†æğŸ‘€

â€‹	Javaçš„forå¾ªç¯ï¼Œå°±æ˜¯å°†Listå¯¹è±¡éå†æ‰˜ç®¡ç»™Iteratorï¼Œä½ å¦‚æœè¦å¯¹listè¿›è¡Œå¢åˆ æ“ä½œï¼Œéƒ½å¿…é¡»ç»è¿‡Iteratorï¼Œå¦åˆ™Iteratoréå†æ—¶ä¼šä¹±ï¼Œæ‰€ä»¥ç›´æ¥å¯¹listè¿›è¡Œåˆ é™¤æ—¶ï¼ŒIteratorä¼šæŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸ã€‚

### å…¶å®ï¼Œæ¯æ¬¡foreachè¿­ä»£çš„æ—¶å€™éƒ½æœ‰ä¸¤éƒ¨æ“ä½œï¼š

```java
// ç¬¬ä¸€æ­¥ï¼šiterator.hasNext() Â åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸ªå…ƒç´ 
public boolean hasNext() {
            return cursor != size;
        }
```
###  ç¬¬äºŒæ­¥ï¼šitem = iterator.next() 

```java
// ä¸‹ä¸ªå…ƒç´ æ˜¯ä»€ä¹ˆï¼Œå¹¶èµ‹å€¼ç»™ä¸Šé¢ä¾‹å­ä¸­çš„itemå˜é‡
public E next() {
            checkForComodification();
            int i = cursor;
            if (i >= size)
                throw new NoSuchElementException();
            Object[] elementData = ArrayList.this.elementData;
            if (i >= elementData.length)
                throw new ConcurrentModificationException();
            cursor = i + 1;
            return (E) elementData[lastRet = i];
        }
```
###  é€šè¿‡debugè°ƒè¯•ï¼Œæˆ‘ä»¬å‘ç°ï¼ŒcheckForComodificationæ—¶è¿”å›äº†å¼‚å¸¸ï¼Œå¼‚å¸¸åŸå› ä¸ºÂ modCount != expectedModCountã€‚

```java
final void checkForComodification() {
            if (modCount != expectedModCount)
                throw new ConcurrentModificationException();
        }
```
###  è¿›ä¸€æ­¥é˜…è¯»æºç ï¼Œå‘ç°

1. modCountÂ æ—¶Listä»newå¼€å§‹ï¼Œè¢«ä¿®æ”¹çš„æ¬¡æ•°ã€‚å½“Listè°ƒç”¨Removeç­‰æ–¹æ³•æ—¶ï¼ŒmodCount++

2. expectedModCountæ˜¯æŒ‡Iteratorç°åœ¨æœŸæœ›è¿™ä¸ªlistè¢«ä¿®æ”¹çš„æ¬¡æ•°æ˜¯å¤šå°‘æ¬¡ã€‚æ˜¯åœ¨Iteratoråˆå§‹åŒ–çš„æ—¶å€™å°†modCountÂ çš„å€¼èµ‹ç»™äº†expectedModCount
###  é‚£ä¹ˆå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆä¼šæŠ¥ä¸Šè¿°å¼‚å¸¸ï¼š

   1. modCountÂ ä¼šéšç€è°ƒç”¨List.removeæ–¹æ³•è€Œè‡ªåŠ¨å¢å‡ï¼Œè€ŒexpectedModCountåˆ™ä¸ä¼šå˜åŒ–ï¼Œå°±å¯¼è‡´modCount != expectedModCountã€‚
   2. åœ¨åˆ é™¤å€’æ•°ç¬¬äºŒä¸ªå…ƒç´ åï¼Œcursor=size-1ï¼Œæ­¤æ—¶size=size-1ï¼Œå¯¼è‡´hasNextæ–¹æ³•è®¤ä¸ºéå†ç»“æŸã€‚

## è§£å†³æ–¹æ³•ğŸŒ¼

åœ¨æ‰¾åˆ°åŸå› åï¼Œåˆ™è¿›ä¸€æ­¥è¿›è¡Œè§£å†³

ç»è¿‡æŸ¥é˜…æºç å¯ä»¥å‘ç°ï¼Œiteratorä¹Ÿæœ‰ä¸€ä¸ªremoveæ–¹æ³•å¦‚ä¸‹ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„æ“ä½œä¸ºexpectedModCount = modCount;è¿™æ ·å°±ä¿è¯äº†ä¸¤è€…çš„ç›¸ç­‰ã€‚

```java
public void remove() {
            if (lastRet < 0)
                throw new IllegalStateException();
            checkForComodification();

            try {
                ArrayList.this.remove(lastRet);
                cursor = lastRet;
                lastRet = -1;
                expectedModCount = modCount;
            } catch (IndexOutOfBoundsException ex) {
                throw new ConcurrentModificationException();
            }
        }
```
ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ï¼š
```java
public class Test {

    public static void main(String[] args) {
        // TODO Auto-generated method stub
        List<Integer> listA=new ArrayList<>();
        listA.add(1);
        listA.add(2);
        listA.add(3);
        listA.add(4);
        listA.add(5);
        listA.add(6);
        Iterator<Integer> it_b=listA.iterator();
        while(it_b.hasNext()){
            Integer a=it_b.next();
            if (a==4) {
                it_b.remove();
            }
        }
        for(Integer b:listA){
            System.out.println(b);
        }
    }
}
```
